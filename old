<?xml version="1.0" encoding="UTF-8"?>
 
 <Server port="-1" shutdown="SHUTDOWN"> <!-- port="-1" means telnet shutdown disabled -->
  <Listener className="org.apache.catalina.startup.VersionLoggerListener" />

  <Listener className="org.apache.catalina.core.JreMemoryLeakPreventionListener" />
  <Listener className="org.apache.catalina.mbeans.GlobalResourcesLifecycleListener" />
  <Listener className="org.apache.catalina.core.ThreadLocalLeakPreventionListener" />

<GlobalNamingResources>
    <Resource name="UserDatabase" auth="Container"
              type="org.apache.catalina.UserDatabase"
              description="User database that can be updated and saved"
              factory="org.apache.catalina.users.MemoryUserDatabaseFactory"
              pathname="conf/tomcat-users.xml" />
  </GlobalNamingResources>
  
  <Service name="Catalina">
 

        <Connector port="8443" protocol="org.apache.coyote.http11.Http11Nio2Protocol"
               SSLEnabled="true" scheme="https" secure="true"
                           maxThreads="1536" minSpareThreads="25" maxConnections="1536" connectionTimeout="20000"
                           enableLookups="false" disableUploadTimeout="true"
                           acceptCount="100" URIEncoding="UTF-8"
                           relaxedPathChars="[]|" relaxedQueryChars="[]|{}^&#x5c;&#x60;&quot;&lt;&gt;">
        <SSLHostConfig protocols="+TLSv1.2"
                                                ciphers="TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384"
                                                truststoreFile="/data/SIGNON/sng80/tomcat/conf/cacert.jks"
                                                truststorePassword="public"
                                                truststoreType="JKS">
            <Certificate certificateKeystoreFile="/data/SIGNON/sng80/tomcat/conf/server.p12"
                         certificateKeystoreType="PKCS12"
                                                 certificateKeystorePassword="secret"
                        />
        </SSLHostConfig>
    </Connector>

   <Engine name="Catalina" defaultHost="localhost">

   <Realm className="org.apache.catalina.realm.LockOutRealm">

        <Realm className="org.apache.catalina.realm.UserDatabaseRealm"
               resourceName="UserDatabase">
                         <CredentialHandler className="org.apache.catalina.realm.MessageDigestCredentialHandler" algorithm="SHA-512" />
                </Realm>
      </Realm>

      <Host name="localhost"  appBase="webapps"
            unpackWARs="true" autoDeploy="true" startStopThreads="0">

                <!-- Use a generic custom error page and not the Tomcat one -->
                <Valve className="org.apache.catalina.valves.ErrorReportValve" errorCode.0="conf/error.html"/>

        <!-- SingleSignOn valve, share authentication between web applications
             Documentation at: /docs/config/valve.html -->
        <Valve className="org.apache.catalina.authenticator.SingleSignOn" />


      </Host>
    </Engine>
  </Service>
</Server>




=============================

cat httpd_signon.conf

<VirtualHost cmvq4h01:9443>
     ServerName cmvq4h01:9443
     ServerAlias cert-usignon.pre.ca-cib.com

    SSLEngine on
    SSLProxyEngine On

    SSLCertificateFile /data/SIGNON/sng72/apache/certs/pre-signon.crt
    SSLCertificateKeyFile /data/SIGNON/sng72/apache/certs/pre-signon.key

        RewriteEngine on
    RewriteRule ^/$ https://cert-usignon.pre.ca-cib.com   [R]
    ProxyPass / https://10.146.84.156:8443/  keepalive=On retry=5
    ProxyPassReverse  / https://10.146.84.156:8443/

    LogLevel warn
    ErrorLog  "|/data/SIGNON/sng72/apache/sbin/rotatelogs /data/SIGNON/sng72/apache/logs/signon_f5_cmvq4h01_error_%y.%m.%d_%H.%M.%S.log 86400 120"
    CustomLog "|/data/SIGNON/sng72/apache/sbin/rotatelogs /data/SIGNON/sng72/apache/logs/signon_f5_cmvq4h01_access_%y.%m.%d_%H.%M.%S.log 86400 120" cacib

    DocumentRoot "/data/SIGNON/sng72/apache/VirtualHosts/sett/wwwroot"

    RewriteCond  %{DOCUMENT_ROOT}/serverdown.txt -f
    RewriteRule ^(/*)$ https://cert-usignon.pre.ca-cib.com/under_maintenance.html
</VirtualHost>

<VirtualHost cmvq4h01:9443>
     ServerName cmvq4h01:9443
     ServerAlias usignon.pre.ca-cib.com

    SSLEngine on
    SSLProxyEngine On

    SSLCertificateFile /data/SIGNON/sng72/apache/certs/pre-signon.crt
    SSLCertificateKeyFile /data/SIGNON/sng72/apache/certs/pre-signon.key

        RewriteEngine on
    RewriteRule ^/$ https://usignon.pre.ca-cib.com   [R]
    ProxyPass / https://10.146.84.156:8443/  keepalive=On retry=5
    ProxyPassReverse  / https://10.146.84.156:8443/

    LogLevel warn
    ErrorLog  "|/data/SIGNON/sng72/apache/sbin/rotatelogs /data/SIGNON/sng72/apache/logs/signon_f5_cmvq4h01_error_%y.%m.%d_%H.%M.%S.log 86400 120"
    CustomLog "|/data/SIGNON/sng72/apache/sbin/rotatelogs /data/SIGNON/sng72/apache/logs/signon_f5_cmvq4h01_access_%y.%m.%d_%H.%M.%S.log 86400 120" cacib

    DocumentRoot "/data/SIGNON/sng72/apache/VirtualHosts/sett/wwwroot"

    RewriteCond  %{DOCUMENT_ROOT}/serverdown.txt -f
    RewriteRule ^(/*)$ https://usignon.pre.ca-cib.com/under_maintenance.html
</VirtualHost>



=============================

cat httpd.conf

ServerTokens Prod
ProxyPreserveHost On
ServerRoot "/data/SIGNON/sng72/apache"
PidFile run/httpd.pid
Timeout 600
KeepAlive On
MaxKeepAliveRequests 100
KeepAliveTimeout 15
LimitRequestFieldSize 131072
Maxhost 200
PersistSlots On

<IfModule prefork.c>
StartServers       8
MinSpareServers    5
MaxSpareServers   20
ServerLimit       1536
MaxClients        1536
MaxRequestsPerChild  4000
</IfModule>


<IfModule worker.c>
StartServers         2
MaxClients         150
MinSpareThreads     25
MaxSpareThreads     75
ThreadsPerChild     25
MaxRequestsPerChild  0
</IfModule>


LoadModule authn_file_module modules/mod_authn_file.so
LoadModule authn_alias_module modules/mod_authn_alias.so
LoadModule authz_host_module modules/mod_authz_host.so
LoadModule include_module modules/mod_include.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule env_module modules/mod_env.so
LoadModule headers_module modules/mod_headers.so
LoadModule usertrack_module modules/mod_usertrack.so
LoadModule setenvif_module modules/mod_setenvif.so
LoadModule mime_module modules/mod_mime.so
LoadModule status_module modules/mod_status.so
LoadModule autoindex_module modules/mod_autoindex.so
LoadModule vhost_alias_module modules/mod_vhost_alias.so
LoadModule negotiation_module modules/mod_negotiation.so
LoadModule dir_module modules/mod_dir.so
LoadModule alias_module modules/mod_alias.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_ftp_module modules/mod_proxy_ftp.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule proxy_connect_module modules/mod_proxy_connect.so
LoadModule cache_module modules/mod_cache.so
LoadModule suexec_module modules/mod_suexec.so
LoadModule disk_cache_module modules/mod_disk_cache.so



LoadModule ssl_module modules/mod_ssl.so

LoadModule proxy_cluster_module modules/mod_proxy_cluster.so
LoadModule slotmem_module modules/mod_slotmem.so
LoadModule manager_module modules/mod_manager.so
LoadModule advertise_module modules/mod_advertise.so


Include conf.d/*.conf
User signon01
Group signon
ServerAdmin root@localhost
UseCanonicalName Off
DocumentRoot "/data/SIGNON/sng72/apache/www/html"


<Directory />
    Options FollowSymLinks
    AllowOverride None
</Directory>

<Directory "/data/SIGNON/sng72/apache/www/html">

    Options FollowSymLinks
    AllowOverride None
    Order allow,deny
    Allow from all

</Directory>


<IfModule mod_userdir.c>

    UserDir disable

</IfModule>


DirectoryIndex index.html index.html.var

AccessFileName .htaccess


<Files ~ "^\.ht">
    Order allow,deny
    Deny from all
</Files>




DefaultType text/plain


<IfModule mod_mime_magic.c>
    MIMEMagicFile conf/magic
</IfModule>


HostnameLookups Off


LogLevel warn


LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
LogFormat "%h %l %u %t \"%r\" %>s %b" common
LogFormat "%{Referer}i -> %U" referer
LogFormat "%{User-agent}i" agent
LogFormat "IP=%{X-Forwarded-For}i USER=%u DATE=%t REQUEST=\"%r\" STATUS=%>s SIZE=\"%B bytes\" REFERER=\"%{Referer}i\" USER-AGENT=\"%{User-Agent}i\" DURATION=\"%D micros\" JSESSIONID=%{JSESSIONID}C" cacibf5


CustomLog logs/access_log combined


ServerSignature Off

Alias /icons/ "/data/SIGNON/sng72/apache/www/icons/"


<IfModule mod_dav_fs.c>
    DAVLockDB /var/lib/dav/lockdb
</IfModule>


ScriptAlias /cgi-bin/ "/data/SIGNON/sng72/apache/www/cgi-bin/"


IndexOptions FancyIndexing VersionSort NameWidth=* HTMLTable

AddIconByEncoding (CMP,/icons/compressed.gif) x-compress x-gzip

AddIconByType (TXT,/icons/text.gif) text/*
AddIconByType (IMG,/icons/image2.gif) image/*
AddIconByType (SND,/icons/sound2.gif) audio/*
AddIconByType (VID,/icons/movie.gif) video/*

AddIcon /icons/binary.gif .bin .exe
AddIcon /icons/binhex.gif .hqx
AddIcon /icons/tar.gif .tar
AddIcon /icons/world2.gif .wrl .wrl.gz .vrml .vrm .iv
AddIcon /icons/compressed.gif .Z .z .tgz .gz .zip
AddIcon /icons/a.gif .ps .ai .eps
AddIcon /icons/layout.gif .html .shtml .htm .pdf
AddIcon /icons/text.gif .txt
AddIcon /icons/c.gif .c
AddIcon /icons/p.gif .pl .py
AddIcon /icons/f.gif .for
AddIcon /icons/dvi.gif .dvi
AddIcon /icons/uuencoded.gif .uu
AddIcon /icons/script.gif .conf .sh .shar .csh .ksh .tcl
AddIcon /icons/tex.gif .tex
AddIcon /icons/bomb.gif core

AddIcon /icons/back.gif ..
AddIcon /icons/hand.right.gif README
AddIcon /icons/folder.gif ^^DIRECTORY^^
AddIcon /icons/blank.gif ^^BLANKICON^^


DefaultIcon /icons/unknown.gif


ReadmeName README.html
HeaderName HEADER.html




AddLanguage ca .ca
AddLanguage cs .cz .cs
AddLanguage da .dk
AddLanguage de .de
AddLanguage el .el
AddLanguage en .en
AddLanguage eo .eo
AddLanguage es .es
AddLanguage et .et
AddLanguage fr .fr
AddLanguage he .he
AddLanguage hr .hr
AddLanguage it .it
AddLanguage ja .ja
AddLanguage ko .ko
AddLanguage ltz .ltz
AddLanguage nl .nl
AddLanguage nn .nn
AddLanguage no .no
AddLanguage pl .po
AddLanguage pt .pt
AddLanguage pt-BR .pt-br
AddLanguage ru .ru
AddLanguage sv .sv
AddLanguage zh-CN .zh-cn
AddLanguage zh-TW .zh-tw


LanguagePriority en ca cs da de el eo es et fr he hr it ja ko ltz nl nn no pl pt pt-BR ru sv zh-CN zh-TW


ForceLanguagePriority Prefer Fallback


AddDefaultCharset UTF-8


AddType application/x-compress .Z
AddType application/x-gzip .gz .tgz


AddHandler type-map var


AddType text/html .shtml
AddOutputFilter INCLUDES .shtml



Alias /error/ "/data/SIGNON/sng72/apache/www/error/"

<IfModule mod_negotiation.c>
<IfModule mod_include.c>
    <Directory "/data/SIGNON/sng72/apache/www/error">
        AllowOverride None
        Options IncludesNoExec
        AddOutputFilter Includes html
        AddHandler type-map var
        Order allow,deny
        Allow from all
        LanguagePriority en es de fr
        ForceLanguagePriority Prefer Fallback
    </Directory>



</IfModule>
</IfModule>


BrowserMatch "Mozilla/2" nokeepalive
BrowserMatch ".*MSIE [2-5]\..*" nokeepalive downgrade-1.0 force-response-1.0
BrowserMatch "RealPlayer 4\.0" force-response-1.0
BrowserMatch "Java/1\.0" force-response-1.0
BrowserMatch "JDK/1\.0" force-response-1.0


BrowserMatch "Microsoft Data Access Internet Publishing Provider" redirect-carefully
BrowserMatch "MS FrontPage" redirect-carefully
BrowserMatch "^WebDrive" redirect-carefully
BrowserMatch "^WebDAVFS/1.[0123]" redirect-carefully
BrowserMatch "^gnome-vfs/1.0" redirect-carefully
BrowserMatch "^XML Spy" redirect-carefully
BrowserMatch "^Dreamweaver-WebDAV-SCM1" redirect-carefully

TraceEnable off


NameVirtualHost cmvq4h01:9443

<IfModule manager_module>
  Listen 192.168.25.100:9443
  ManagerBalancerName mycluster
  <VirtualHost 192.168.25.100:9443>
    ServerName cert-usignon.pre.ca-cib.com
    ServerAlias usignon.pre.ca-cib.com usignon.pre.ca.cib

    <Location /auth/tls>
    </Location>

    KeepAliveTimeout 300
    MaxKeepAliveRequests 0
    ServerAdvertise off
    EnableMCPMReceive on

    SSLEngine on
    SSLProxyEngine On

    SSLProtocol -ALL  +TLSv1.2

    SSLCipherSuite ECDHE-RSA-AES256-SHA384:AES256-SHA256:HIGH:!3DES:!RC4:!MD5:!aNULL:!EDH:!EXP:!eNULL

    SSLCertificateFile /data/SIGNON/sng72/apache/certs/pre-signon.crt
    SSLCertificateKeyFile /data/SIGNON/sng72/apache/certs/pre-signon.key

    ProxyPass / https://192.168.25.116:8443/
    ProxyPassReverse / https://192.168.25.116:8443/

    RequestHeader set CERT_CLIENT "%{SSL_CLIENT_CERT}s"

    LogLevel warn
    ErrorLog "|/data/SIGNON/sng72/apache/sbin/rotatelogs /data/SIGNON/sng72/apache/VirtualHosts/f5/logs/cmvq4h01_error_%y.%m.%d_%H.%M.%S.log 86400 120"
    CustomLog "|/data/SIGNON/sng72/apache/sbin/rotatelogs /data/SIGNON/sng72/apache/VirtualHosts/f5/logs/cmvq4h01_access_%y.%m.%d_%H.%M.%S.log 86400 120" cacibf5
    DocumentRoot "/data/SIGNON/sng72/apache/VirtualHosts/f5/wwwroot"

  </VirtualHost>

</IfModule>



Include conf/httpd_*.conf
